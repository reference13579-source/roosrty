<!DOCTYPE html>
<html>
<head>
    <title>Обработка авторизации</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');

            if (accessToken) {
                fetch('https://login.yandex.ru/info?format=json', {
                    headers: { 'Authorization': `OAuth ${accessToken}` }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Ошибка запроса');
                    return response.json();
                })
                .then(data => {
                    const userData = {
                        id: data.id,
                        login: data.login,
                        display_name: data.display_name,
                        first_name: data.first_name,
                        last_name: data.last_name,
                        default_email: data.default_email
                    };
                    
                    localStorage.setItem('yandexUser', JSON.stringify(userData));
                    // Отправляем сообщение в родительское окно
                    if (window.opener) {
                        const targetOrigin = 'https://roosty.ru';
                        window.opener.postMessage({ type: 'yandex_auth_success' }, 'https://roosty.ru');
                        window.close();
                    } else {
                        window.location.href = 'void.html';
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    window.location.href = '/';
                });
            } else {
                window.location.href = '/';
            }
        });
    </script>
</head>
<body>
    <p>Пожалуйста, подождите, идет авторизация...</p>
</body>
</html>